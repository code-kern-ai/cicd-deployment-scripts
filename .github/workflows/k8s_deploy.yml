name: 'K8: Deploy'

on:
  workflow_call:

# Special permissions required for OIDC authentication
permissions:
  id-token: write
  contents: read
  actions: read

jobs:
  az-acr-push:
    name: "Docker: Build & Push"
    runs-on: ubuntu-latest
    environment: ${{ github.event_name == 'release' && 'prod' || 'dev' }}
    env:
      DOCKERFILE: ${{ vars.DOCKERFILE }}
      AZURE_CONTAINER_REGISTRY: ${{ vars.AZURE_CONTAINER_REGISTRY }}
      ACR_LOGIN_USERNAME: ${{ secrets.ACR_LOGIN_USERNAME }}
      ACR_LOGIN_PASSWORD: ${{ secrets.ACR_LOGIN_PASSWORD }}
      IMAGE_TAG: ${{ github.event_name == 'release' && github.event.release.tag_name || 'amd64' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3      
      - name: Log into registry
        uses: docker/login-action@v3
        with:
          registry: "${{ env.AZURE_CONTAINER_REGISTRY }}"
          username: "${{ env.ACR_LOGIN_USERNAME }}"
          password: "${{ env.ACR_LOGIN_PASSWORD }}"
      
      - name: Build & Push
        uses: docker/build-push-action@v5
        with:
          cache-from: type=gha
          cache-to: type=gha,mode=max
          file: ${{ env.DOCKERFILE }}
          tags: ${{ env.AZURE_CONTAINER_REGISTRY }}/${{ github.event.repository.name }}:${{ env.IMAGE_TAG }}
          push: true
          build-args: platform=linux/amd64
  
  k8-deploy:
    name: 'K8: Deploy'
    runs-on: ubuntu-latest
    needs: [az-acr-push]
    environment: ${{ github.event_name == 'release' && 'prod' || 'dev' }}
    env:
      KUBELOGIN_VERSION: "v0.0.25"
      KUBERNETES_CLUSTER_REPO_NAME: "${{ vars.KUBERNETES_CLUSTER_REPO_NAME }}"
      KUBERNETES_CLUSTER_NAME: "${{ vars.KUBERNETES_CLUSTER_NAME }}"
      KUBERNETES_NAMESPACE: "${{ vars.KUBERNETES_NAMESPACE }}"
      KUBERNETES_MANIFEST_PATH: "${{ vars.KUBERNETES_MANIFEST_PATH }}"
      AZURE_RESOURCE_GROUP: "${{ vars.AZURE_RESOURCE_GROUP }}"
      AZURE_CONTAINER_REGISTRY: "${{ vars.AZURE_CONTAINER_REGISTRY }}"
      IMAGE_TAG: ${{ github.event_name == 'release' && github.event.release.tag_name || 'amd64' }}
    steps:
    # Checkout the repository to the GitHub Actions runner
    - name: Checkout
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.TOKEN_GITHUB }}
        repository: ${{ github.repository_owner }}/${{ env.KUBERNETES_CLUSTER_REPO_NAME }}
        ref: refs/heads/dev

    # Install the latest version of Kubernetes CLI and configure the Kubernetes CLI configuration file with a Kubernetes Cloud user API token
    - name: Azure Cloud Login
      uses: Azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    # Use kubelogin to configure your kubeconfig for Azure auth
    - name: Set up kubelogin for non-interactive login
      uses: azure/use-kubelogin@v1
      with:
        kubelogin-version: ${{ env.KUBELOGIN_VERSION }}

    - uses: azure/aks-set-context@v3
      with:
        resource-group: ${{ env.AZURE_RESOURCE_GROUP }}
        cluster-name: ${{ env.KUBERNETES_CLUSTER_NAME }}
        admin: 'false'
        use-kubelogin: 'true'
    
    - name: Generate Kustomization
      shell: bash
      run: |
        kubectl kustomize ${{ env.KUBERNETES_MANIFEST_PATH }} --output apply.yml
        cat apply.yml
  
    - name: Generate Deployment
      uses: Azure/k8s-deploy@v5
      timeout-minutes: 5
      with:
         namespace: ${{ env.KUBERNETES_NAMESPACE }}
         manifests: apply.yml
         pull-images: false
         images: ${{ env.AZURE_CONTAINER_REGISTRY }}/${{ github.event.repository.name }}:${{ env.IMAGE_TAG }}
         strategy: canary
         action: deploy
         percentage: 20
 
    - name: Promote Deployment
      uses: Azure/k8s-deploy@v5
      if: success()
      with:
        namespace: ${{ env.KUBERNETES_NAMESPACE }}
        manifests: apply.yml
        pull-images: false
        images: ${{ env.AZURE_CONTAINER_REGISTRY }}/${{ github.event.repository.name }}:${{ env.IMAGE_TAG }}
        strategy: canary
        action: promote

    - name: Reject Deployment
      uses: Azure/k8s-deploy@v5
      if: failure() || cancelled()
      with:
        namespace: ${{ env.KUBERNETES_NAMESPACE }}
        manifests: apply.yml
        pull-images: false
        images: ${{ env.AZURE_CONTAINER_REGISTRY }}/${{ github.event.repository.name }}:${{ env.IMAGE_TAG }}
        strategy: canary
        action: reject

  gh-release-publish:
    name: 'GitHub: Publish Release'
    runs-on: ubuntu-latest
    needs: [k8-deploy]
    if: github.event_name == 'release' && success()
    env:
      GH_TOKEN: ${{ secrets.TOKEN_GITHUB }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.TOKEN_GITHUB }}
          repository: ${{ github.repository_owner }}/${{ github.event.repository.name }}
          ref: refs/heads/dev
      
      - name: Upload Assets
        run: |
          zip -r ${{ github.event.release.tag_name }}.zip .
          tar -czvf ${{ github.event.release.tag_name }}.tar.gz .

          gh release upload ${{ github.event.release.tag_name }} \
            --clobber \
            --repo ${{ github.repository }} \
            ${{ github.event.release.tag_name }}.zip \
            ${{ github.event.release.tag_name }}.tar.gz
          
          echo "::notice::Assets Uploaded"

      - name: Publish Release
        run: |
          gh release edit ${{ github.event.release.tag_name }} \
            --prerelease=false \
            --draft=false \
            --latest \
            --repo ${{ github.repository }}
          
          echo "::notice::Release Published"

  gh-release-delete:
    name: 'GitHub: Delete Prerelease'
    runs-on: ubuntu-latest
    needs: [k8-deploy]
    if: github.event_name == 'release' && failure() || cancelled()
    env:
      GH_TOKEN: ${{ secrets.TOKEN_GITHUB }}
    steps:
      - name: Delete Prerelease
        run: |
          gh release delete ${{ github.event.release.tag_name }} \
            --cleanup-tag \
            --yes \
            --repo ${{ github.repository }}
          
          echo "::error::Prerelease and Tag Deleted"